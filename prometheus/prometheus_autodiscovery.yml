groups:
  - name: recording_rules
    interval: 15s
    rules:
      - record: instance:node_cpu_utilization_percent:rate5m
        expr: 100 * (1 - avg by(instance)(irate(node_cpu{mode='idle'}[5m])))

      - record: node_exporter:node_filesystem_free:fs_used_percents
        expr: 100 - 100 * ( node_filesystem_free{mountpoint="/"} / node_filesystem_size{mountpoint="/"} )

      - record: node_exporter:node_memory_free:memory_used_percents
        expr: 100 - 100 * (node_memory_MemFree / node_memory_MemTotal)

      - record: alerts_fired:24h
        expr:   sort_desc(sum(sum_over_time(ALERTS{alertstate=`firing`}[24h])) by (alertname))

  - name: alerting_rules
    rules:
      - alert: HostCPUUtilisation
        expr: 100 - (avg by(instance) (irate(node_cpu{mode="idle"}[5m])) * 100) > 70
        for: 10m
        labels:
          severity: warning
        annotations:
          description: 'High CPU utilisation detected for instance {{ $labels.instance_id}} tagged as: {{ $labels.instance_name_tag }}, the utilisation is currently:{{ $value }}%'
          summary: CPU Utilisation Alert

      - alert: LoadAverage15m
        expr: node_load15 >= 6.00
        labels:
          severity: major
        annotations:
          summary: "Instance {{ $labels.instance }} - high load average"
          description: "{{ $labels.instance  }} (measured by {{ $labels.job }}) has high load average ({{ $value }}) over 15 minutes."

      - alert: JobInstanceDown
        expr: up == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Instance {{ $labels.instance }} - instance is down"
          description: "Instance {{ $labels.instance }} instance {{ $labels.instance }} is down."

      - alert: MemoryFree10%
        expr: node_exporter:node_memory_free:memory_used_percents >= 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Instance {{ $labels.instance }} hight memory usage"
          description: "{{ $labels.instance }} has more than 90% of its memory used."

      - alert: DiskSpace10%Free
        expr: node_exporter:node_filesystem_free:fs_used_percents >= 90
        labels:
          severity: moderate
        annotations:
          summary: "Instance {{ $labels.instance }} is low on disk space"
          description: "{{ $labels.instance }} has only {{ $value }}% free."
[root@infra-prometheus-prod-1 prometheus]# ll
total 96204
-rw-r--r--  1 prometheus prometheus    11357 Jan 31 12:17 LICENSE
-rw-r--r--  1 prometheus prometheus     2769 Jan 31 12:17 NOTICE
drwxr-xr-x  2 prometheus root             54 Apr 10 05:47 aggregation
drwxr-xr-x  2 root       root             28 Apr 10 05:30 backup
drwxr-xr-x  2 prometheus prometheus       38 Jan 31 12:17 console_libraries
drwxr-xr-x  2 prometheus prometheus      173 Jan 31 12:17 consoles
drwxr-xr-x 26 prometheus prometheus     4096 Apr 13 13:00 data
-rwxr-xr-x  1 prometheus prometheus 60097588 Jan 31 11:18 prometheus
-rw-r--r--  1 root       root          18916 Apr 10 07:38 prometheus.yml
-rw-r--r--  1 root       root            926 Feb 11 11:12 prometheus.yml.original
-rwxr-xr-x  1 prometheus prometheus 38359349 Jan 31 11:19 promtool
-rw-r--r--  1 root       root           2423 Feb 25 05:57 rules.yml
[root@infra-prometheus-prod-1 prometheus]# cat prometheus.yml
# my global config
global:
  scrape_interval:     120s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 120s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
  - static_configs:
    - targets:
       - localhost:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
    - "rules.yml"
  # - "second_rules.yml"

# Here it's Prometheus itself.
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
    - targets: ['localhost:9090']

#########################################################################
##########################################################################
###########################<< AGGREGATION 1 >>############################
##########################################################################
##########################################################################
##########################################################################

  - job_name: 'AGG1-FreeProd-DailyReviewAggregation'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - Aggregation
      - name: tag:Name
        values:
          - FreeProd-DailyReviewAggregation
      - name: tag:Environment
        values:
          - FREE-Production
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.


  - job_name: 'AGG1-FreeProd-DailyReviewAggregationRetry'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - Aggregation
      - name: tag:Name
        values:
          - FreeProd-DailyReviewAggregationRetry
      - name: tag:Environment
        values:
          - FREE-Production
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG1-FreeProd-ReaggregationReviewAggregation'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - Aggregation
      - name: tag:Name
        values:
          - FreeProd-ReaggregationReviewAggregation
      - name: tag:Environment
        values:
          - FREE-Production
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG1-FreeProd-SearchProfileAggregation'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - Aggregation
      - name: tag:Name
        values:
          - FreeProd-SearchProfileAggregation
      - name: tag:Environment
        values:
          - FREE-Production
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG1-FreeProd-SearchProfileAggregationRetry-1'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - Aggregation
      - name: tag:Name
        values:
          - FreeProd-SearchProfileAggregationRetry-1
      - name: tag:Environment
        values:
          - FREE-Production
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG1-prod-paid-aggregation-daily-review-agg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - aggregation
      - name: tag:Name
        values:
          - prod-paid-aggregation-daily-review-agg
      - name: tag:Environment
        values:
          - prod
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG1-prod-paid-aggregation-daily-review-agg-retry'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - aggregation
      - name: tag:Name
        values:
          - prod-paid-aggregation-daily-review-agg-retry
      - name: tag:Environment
        values:
          - prod
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG1-prod-paid-aggregation-competitor-review-agg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - aggregation
      - name: tag:Name
        values:
          - prod-paid-aggregation-competitor-review-agg
      - name: tag:Environment
        values:
          - prod
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG1-prod-paid-aggregation-reaggregation-review-agg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - aggregation
      - name: tag:Name
        values:
          - prod-paid-aggregation-reaggregation-review-agg
      - name: tag:Environment
        values:
          - prod
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG1-prod-paid-aggregation-replies-agg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - aggregation
      - name: tag:Name
        values:
          - prod-paid-aggregation-replies-agg
      - name: tag:Environment
        values:
          - prod
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG1-prod-paid-aggregation-asg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 120s
      port: 9100
      filters:
      - name: tag:Name
        values:
          - prod-paid-aggregation-asg
      - name: tag:Environment
        values:
          - prod
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG1-free-paid-aggregation-asg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 120s
      port: 9100
      filters:
      - name: tag:Name
        values:
          - free-prod-aggregation-asg
      - name: tag:Environment
        values:
          - freeprod
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

#########################################################################
#########################################################################
##########################<< AGGREGATION 2 >>############################
#########################################################################
#########################################################################
#########################################################################

  - job_name: 'AGG2-FreeProd-DailyReviewAggregation'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - Aggregation
      - name: tag:Name
        values:
          - FreeProd-DailyReviewAggregation
      - name: tag:Environment
        values:
          - FREE-Production
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.


  - job_name: 'AGG2-FreeProd-DailyReviewAggregationRetry'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - Aggregation
      - name: tag:Name
        values:
          - FreeProd-DailyReviewAggregationRetry
      - name: tag:Environment
        values:
          - FREE-Production
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG2-FreeProd-ReaggregationReviewAggregation'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - Aggregation
      - name: tag:Name
        values:
          - FreeProd-ReaggregationReviewAggregation
      - name: tag:Environment
        values:
          - FREE-Production
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG2-FreeProd-SearchProfileAggregation'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - Aggregation
      - name: tag:Name
        values:
          - FreeProd-SearchProfileAggregation
      - name: tag:Environment
        values:
          - FREE-Production
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG2-FreeProd-SearchProfileAggregationRetry-1'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - Aggregation
      - name: tag:Name
        values:
          - FreeProd-SearchProfileAggregationRetry-1
      - name: tag:Environment
        values:
          - FREE-Production
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG2-prod-paid-aggregation-daily-review-agg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - aggregation
      - name: tag:Name
        values:
          - prod-paid-aggregation-daily-review-agg
      - name: tag:Environment
        values:
          - prod
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG2-prod-paid-aggregation-daily-review-agg-retry'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - aggregation
      - name: tag:Name
        values:
          - prod-paid-aggregation-daily-review-agg-retry
      - name: tag:Environment
        values:
          - prod
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG2-prod-paid-aggregation-competitor-review-agg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - aggregation
      - name: tag:Name
        values:
          - prod-paid-aggregation-competitor-review-agg
      - name: tag:Environment
        values:
          - prod
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG2-prod-paid-aggregation-reaggregation-review-agg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - aggregation
      - name: tag:Name
        values:
          - prod-paid-aggregation-reaggregation-review-agg
      - name: tag:Environment
        values:
          - prod
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG2-prod-paid-aggregation-replies-agg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 300s
      port: 9100
      filters:
      - name: tag:Team
        values:
          - aggregation
      - name: tag:Name
        values:
          - prod-paid-aggregation-replies-agg
      - name: tag:Environment
        values:
          - prod
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG2-prod-paid-aggregation-asg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 120s
      port: 9100
      filters:
      - name: tag:Name
        values:
          - prod-paid-aggregation-asg
      - name: tag:Environment
        values:
          - prod
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too.

  - job_name: 'AGG2-free-paid-aggregation-asg'
    ec2_sd_configs:
    - region: us-east-1
      refresh_interval: 120s
      port: 9100
      filters:
      - name: tag:Name
        values:
          - free-prod-aggregation-asg
      - name: tag:Environment
        values:
          - freeprod
      role_arn: arn:aws:iam::939261055124:role/birdeye-prometheus-server-role
    relabel_configs:
    - source_labels: [__meta_ec2_instance_state]
      regex: running
      action: keep
    - source_labels: [__meta_ec2_public_ip]
      regex:  '(.*)'             # This is the default value.
      target_label: __address__
      replacement: '${1}:9100'   # Have to specify a port too

